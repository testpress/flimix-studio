name: Deploy Build to S3

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      remote_directory:
        description: 'Optional: S3 folder to deploy to. Defaults to the studio directory.'
        required: false
        default: 'static/studio'
        type: string

env:
  AWS_REGION: eu-central-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.19.6'

    - name: Install dependencies
      run: npm ci

    - name: Build Flimix Studio
      run: npm run build

    - name: Set remote directory
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.remote_directory }}" ]; then
          echo "REMOTE_DIR=${{ github.event.inputs.remote_directory }}" >> $GITHUB_ENV
        else
          echo "REMOTE_DIR=static/studio" >> $GITHUB_ENV
        fi
    
    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Deploy to S3 using rclone
      run: |
        S3_BUCKET="flimix.testpress.in"
        
        echo "Deploying to S3 bucket: $S3_BUCKET"
        echo "Remote directory: $REMOTE_DIR"
        
        # Create rclone config for Wasabi
        cat > rclone.conf << EOF
        [s3]
        type = s3
        provider = Other
        access_key_id = $AWS_ACCESS_KEY_ID
        secret_access_key = $AWS_SECRET_ACCESS_KEY
        endpoint = s3.eu-central-1.wasabisys.com
        region = $AWS_REGION
        force_path_style = true
        no_check_bucket = true
        signature_version = v4
        EOF
        
        # Copy all build files to S3 with appropriate cache headers and MIME types
        echo "Copying build files to S3..."
        
        # Copy all files to S3 with public access
        echo "Copying build files to S3..."
        rclone copy dist/ "s3:$S3_BUCKET/$REMOTE_DIR/" \
          --config rclone.conf \
          --checksum \
          --transfers 10 \
          --s3-acl public-read

    - name: Deploy success
      run: |
        echo "Successfully deployed Flimix Studio to $REMOTE_DIR"
